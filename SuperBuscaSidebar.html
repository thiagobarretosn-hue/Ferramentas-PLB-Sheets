<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1a73e8; --bg: #f8f9fa; --surface: #ffffff;
      --border: #dadce0; --text: #202124; --hover: #e8f0fe;
    }
    body {
      font-family: 'Roboto', sans-serif; margin: 0; padding: 0;
      background-color: var(--bg); display: flex; flex-direction: column;
      height: 100vh; overflow: hidden; font-size: 13px;
    }
    /* CONFIG */
    .config-header {
      background: #e8eaed; padding: 8px 16px; font-size: 11px;
      color: #5f6368; cursor: pointer; display: flex;
      justify-content: space-between; align-items: center;
      border-bottom: 1px solid var(--border);
    }
    .config-panel {
      display: none; background: #f1f3f4; padding: 12px 16px;
      border-bottom: 1px solid var(--border); flex-direction: column; gap: 8px;
    }
    .config-panel.open { display: flex; }
    .config-row { display: flex; gap: 8px; align-items: center; }
    .config-row label { flex: 1; font-weight: 500; color: var(--text); }
    
    select {
      flex: 2; padding: 4px; border: 1px solid var(--border);
      border-radius: 4px; background: white; width: 100%;
    }
    .btn-reload {
      background-color: #5f6368; color: white; border: none; padding: 6px;
      border-radius: 4px; cursor: pointer; width: 100%; margin-top: 4px;
    }
    /* BUSCA */
    .header {
      padding: 12px 16px; background: var(--surface);
      border-bottom: 1px solid var(--border); z-index: 10;
    }
    input#searchInput {
      width: 100%; box-sizing: border-box; padding: 10px 12px;
      border: 1px solid var(--border); border-radius: 4px;
      font-size: 14px; outline: none;
    }
    input#searchInput:focus { border-color: var(--primary); }
    .results-container { flex: 1; overflow-y: auto; padding: 8px 0; }
    .result-item {
      padding: 8px 16px; cursor: pointer; display: flex;
      align-items: center; gap: 10px; color: var(--text);
    }
    .result-item:hover { background-color: #f1f3f4; }
    .result-item.selected { background-color: var(--hover); color: var(--primary); font-weight: 500; }
    .custom-check {
      width: 16px; height: 16px; border: 2px solid #5f6368; border-radius: 2px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; background: white;
    }
    .result-item.selected .custom-check { background-color: var(--primary); border-color: var(--primary); }
    .result-item.selected .custom-check::after { content: '✓'; color: white; font-size: 12px; font-weight: bold; }
    .footer {
      padding: 12px 16px; background: var(--surface); border-top: 1px solid var(--border);
      display: flex; justify-content: space-between; align-items: center;
    }
    button#btnInsert {
      background-color: var(--primary); color: white; border: none; padding: 8px 20px;
      border-radius: 4px; font-weight: 600; cursor: pointer; opacity: 0.5; pointer-events: none;
    }
    button#btnInsert.active { opacity: 1; pointer-events: auto; }
  </style>
</head>
<body>

  <div class="config-header" onclick="toggleConfig()">
    <span>⚙️ Configuração da Fonte</span>
    <span id="configIcon">▼</span>
  </div>

  <div class="config-panel" id="configPanel">
    <div class="config-row">
      <label>Aba:</label>
      <select id="sheetSelect" onchange="loadColumnsForSheet()"></select>
    </div>
    <div class="config-row">
      <label>Coluna:</label>
      <select id="colSelect"></select>
    </div>
    <button class="btn-reload" onclick="reloadData()">Atualizar Lista</button>
  </div>

  <div class="header">
    <input type="text" id="searchInput" placeholder="Filtrar..." autocomplete="off" autofocus>
  </div>

  <div class="results-container" id="resultsList">
    <div style="padding:20px; text-align:center; color:#888;">Carregando...</div>
  </div>

  <div class="footer">
    <span class="info-text" id="statusText">0 itens</span>
    <button id="btnInsert" onclick="inserirDados()">INSERIR</button>
  </div>

  <script>
    let rawData = [];
    let selectedSet = new Set();
    const DEFAULT_SHEET = '5.COST.LIST';
    const DEFAULT_COL_INDEX = 6;

    window.onload = () => {
      google.script.run.withSuccessHandler(populateSheetSelect).getSheetList();
    };

    function populateSheetSelect(sheets) {
      const select = document.getElementById('sheetSelect');
      select.innerHTML = '';
      sheets.forEach(sheetName => {
        const option = document.createElement('option');
        option.value = sheetName;
        option.text = sheetName;
        if (sheetName === DEFAULT_SHEET) option.selected = true;
        select.appendChild(option);
      });
      loadColumnsForSheet(true); 
    }

    function loadColumnsForSheet(isInitialLoad = false) {
      const sheetName = document.getElementById('sheetSelect').value;
      const colSelect = document.getElementById('colSelect');
      colSelect.innerHTML = '<option>Carregando...</option>';
      colSelect.disabled = true;

      google.script.run
        .withSuccessHandler((headers) => populateColumnSelect(headers, isInitialLoad))
        .getColumnHeaders(sheetName);
    }

    function populateColumnSelect(headers, isInitialLoad) {
      const select = document.getElementById('colSelect');
      select.innerHTML = '';
      select.disabled = false;

      if (headers.length === 0) {
        select.innerHTML = '<option>(Sem colunas)</option>';
        return;
      }

      headers.forEach(h => {
        const option = document.createElement('option');
        option.value = h.index;
        option.text = h.name;
        if (isInitialLoad && h.index === DEFAULT_COL_INDEX) {
          option.selected = true;
        }
        select.appendChild(option);
      });

      if (isInitialLoad) reloadData();
    }

    function toggleConfig() {
      const panel = document.getElementById('configPanel');
      panel.classList.toggle('open');
      document.getElementById('configIcon').innerText = panel.classList.contains('open') ? '▲' : '▼';
    }

    function reloadData() {
      const list = document.getElementById('resultsList');
      list.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Carregando dados...</div>';
      
      const sheetVal = document.getElementById('sheetSelect').value;
      const colVal = document.getElementById('colSelect').value;

      google.script.run
        .withSuccessHandler(onDataLoaded)
        .withFailureHandler(err => list.innerHTML = `Erro: ${err.message}`)
        .getDadosParaBusca(sheetVal, colVal);
    }

    function onDataLoaded(data) {
      rawData = data || [];
      const list = document.getElementById('resultsList');
      list.innerHTML = rawData.length === 0 
        ? '<div style="padding:20px; text-align:center; color:#888;">Lista vazia.</div>'
        : '<div style="padding:20px; text-align:center; color:#888;">Digite para filtrar...</div>';
      
      selectedSet.clear();
      updateFooter();
      const currentSearch = document.getElementById('searchInput').value;
      if (currentSearch) runFilter();
      document.getElementById('searchInput').addEventListener('input', runFilter);
    }

    function runFilter() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      if (!query.trim()) {
        renderList([]); 
        document.getElementById('resultsList').innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Digite para filtrar...</div>';
        return;
      }
      const tokens = query.split(/\s+/).filter(t => t.length > 0);
      const filtered = rawData.filter(item => {
        const itemLower = item.toLowerCase();
        return tokens.every(token => itemLower.includes(token));
      });
      renderList(filtered);
    }

    // --- FUNÇÃO DE RENDERIZAÇÃO SEM LIMITES ---
    function renderList(items) {
      const container = document.getElementById('resultsList');
      container.innerHTML = '';

      if (items.length === 0) {
        container.innerHTML = '<div style="padding:20px; text-align:center; color:#888;">Nenhum resultado.</div>';
        return;
      }

      // REMOVIDO: const limit = 50;
      // REMOVIDO: const viewItems = items.slice(0, limit);
      
      // AGORA EXIBE TUDO
      items.forEach(text => {
        const div = document.createElement('div');
        const isSelected = selectedSet.has(text);
        div.className = `result-item ${isSelected ? 'selected' : ''}`;
        div.onclick = () => toggleItem(text, div);
        div.innerHTML = `<div class="custom-check"></div><span>${text}</span>`;
        container.appendChild(div);
      });
      
      // REMOVIDO: Bloco "if (items.length > limit) { ... }"
    }

    function toggleItem(text, el) {
      if (selectedSet.has(text)) {
        selectedSet.delete(text);
        el.classList.remove('selected');
      } else {
        selectedSet.add(text);
        el.classList.add('selected');
      }
      updateFooter();
    }

    function updateFooter() {
      const count = selectedSet.size;
      document.getElementById('statusText').innerText = `${count} selecionado(s)`;
      const btn = document.getElementById('btnInsert');
      if (count > 0) {
        btn.classList.add('active');
        btn.innerText = `INSERIR (${count})`;
      } else {
        btn.classList.remove('active');
        btn.innerText = 'INSERIR';
      }
    }

    function inserirDados() {
      const itens = Array.from(selectedSet);
      if (itens.length === 0) return;
      const btn = document.getElementById('btnInsert');
      btn.innerText = '...';
      google.script.run
        .withSuccessHandler(() => {
          selectedSet.clear();
          document.querySelectorAll('.result-item.selected').forEach(el => el.classList.remove('selected'));
          updateFooter();
          btn.innerText = "SUCESSO!";
          setTimeout(() => updateFooter(), 1500);
          document.getElementById('searchInput').focus();
        })
        .inserirItensSelecionados(itens);
    }
  </script>
</body>
</html>